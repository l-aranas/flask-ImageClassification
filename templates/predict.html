<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Classification - Predictions</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .predict-image {
            width: 150px; 
            height: 150px; 
            object-fit: cover; 
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .predict-image:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .selected {
            border: 3px solid #007bff !important;
        }
        #loading-spinner {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2 class="text-center">Image Prediction</h2>
        
        <!-- Display Uploaded Images -->
        <div class="mb-4 text-center">
            <h4>Click an Image to Predict</h4>
            <div id="image-gallery" class="row justify-content-center">
                {% for image in images %}
                <div class="col-md-3 mb-3 d-flex justify-content-center">
                    <img src="{{ url_for('static', filename='uploads/' + image) }}" 
                         class="img-thumbnail predict-image" 
                         data-filename="{{ image }}" 
                         alt="Uploaded Image">
                </div>
                {% endfor %}
            </div>

            <!-- Loading Spinner -->
            <div id="loading-spinner" class="mt-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Predicting...</p>
            </div>
        </div>
    </div>

    <!-- Prediction Result Modal -->
    <div class="modal fade" id="predictionModal" tabindex="-1" aria-labelledby="predictionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="predictionModalLabel">Prediction Result</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <h4 id="predict-result"></h4>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            let images = document.querySelectorAll(".predict-image");
            let resultText = document.getElementById("predict-result");
            let loadingSpinner = document.getElementById("loading-spinner");
            let predictionModal = new bootstrap.Modal(document.getElementById("predictionModal"));

            images.forEach(img => {
                img.addEventListener("click", async function() {
                    // Remove previous selections
                    images.forEach(i => i.classList.remove("selected"));
                    this.classList.add("selected");

                    let filename = this.getAttribute("data-filename");

                    // Show loading spinner
                    loadingSpinner.style.display = "block";
                    resultText.innerText = "";

                    try {
                        let response = await fetch(`/predict_image?filename=${filename}`);
                        let result = await response.json();

                        loadingSpinner.style.display = "none";

                        if (result.error) {
                            resultText.innerText = "❌ Error: " + result.error;
                            resultText.style.color = "red";
                        } else {
                            resultText.innerText = `✅ Predicted Class: ${result.prediction}`;
                            resultText.style.color = "green";
                        }

                        // Show modal with prediction
                        predictionModal.show();

                    } catch (error) {
                        loadingSpinner.style.display = "none";
                        resultText.innerText = "⚠️ Prediction failed!";
                        resultText.style.color = "red";

                        // Show modal in case of failure
                        predictionModal.show();
                    }
                });
            });
        });
    </script>
</body>
</html>
